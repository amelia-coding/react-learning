# ğŸ›´5.React Hooks åŸç†

### 5-1.å†…éƒ¨å®ç°

> useState å…¶å®æ˜¯ä¸€ä¸ªç®€ç‰ˆçš„ useReducerï¼Œå› ä¸º Redux çš„ä½œè€…å…¥èŒäº† React ä»¥åï¼Œå°†åŸæœ‰çš„ Redux çš„æ ¸å¿ƒç†è®ºç§»æ¤ç»™äº† Hooks

### 5-2.ç®€ç‰ˆçš„å®ç°

```JavaScript
let state
# å‡½æ•°æ›´æ–°çš„æ—¶å€™ç¬¬ä¸€æ¬¡å–åˆ°çš„defaultStateï¼Œ æ‹¿åˆ°æ›´æ”¹åçš„å€¼
function useState(defaultState) {
  function setState(newState) {
    state = newState
  }

  if (!state) {
    state = defaultState
  }
  return [state, setState]
}

function functionA() {
  const [state, setState] = useState(0)
  console.log(state)
  setState(state + 1)
}
```

`çŠ¶æ€å †ä¸ä¸Šä¸‹æ–‡æ ˆå­˜å‚¨å¤šä¸ªçŠ¶æ€å¤šä¸ªå‡½æ•°`

```JavaScript
let contextStack = []

function useState(defaultState=0) {
  # ç¬¬4æ­¥  [{ nu: 0, {} }] 
  # { nu: 0, {} }
  # å¾—åˆ°æœ€åä¸€ä¸ªå…ƒç´ , å°±æ˜¯æŒ‰é¡ºåºè·å–çš„å¯¹åº”çš„contextï¼Œ withStateæ”¾å…¥çš„contextå°±æ˜¯é€šè¿‡useState è·å–çš„context
  const context = contextStack[contextStack.length - 1]
  const nu = context.nu++
  # { nu: 1, {} }
  # 1 => ç¬¬ä¸€ä¸ªuseState  
  # 2 => ç¬¬2ä¸ªuseState

  const { states } = context

  function setState(newState) {
    states[nu] = newState
  }
	# {}
  if (!states[nu]) {
    states[nu] = defaultState
  }
 # { nu: 1, {1: 0} } 
 # { nu: 2, {1: 0, 2: "name"} }
  return [states[nu], setState]
}

function withState(func) {
  const states = {}
  return (...args) => {
    # 1.ç¬¬ä¸€æ­¥
    # åœ¨æ‰§è¡Œå‡½æ•°ç»„ä»¶ä¹‹å‰ï¼Œ æ·»åŠ ä¸€ä¸ªcontext [{ nu: 0, {} }] 
    contextStack.push({ nu: 0, states })
    # 2. ç¬¬äºŒæ­¥
    const result = func(...args)
    # å†æ‰§è¡Œå‡½æ•°ç»„ä»¶ä¹‹åï¼Œ å¼¹å‡º
    contextStack.pop()
    return result
  }
}

const render = withState(
  function render() {
    # 3. ç¬¬ä¸‰æ­¥
    const [state, setState] = useState(0)
    const [name, setName] = useState("name")

    render1()

    console.log('render', state)
    setState(state + 1)
  }
)

const render1 = withState(
  function render1() {
    const [state, setState] = useState(0)

    console.log('render1', state)
    setState(state + 2)
  }
)
# [{ nu: 0, {} }] 
render1()

# å¯¹å¤šä¸ªå‡½æ•°ç»„ä»¶ä½¿ç”¨stateï¼Œ æ¯ä¸ªå‡½æ•°ç»„ä»¶å¯ä»¥ä½¿ç”¨å¤šä¸ªuseState
```



```javascript

let memoizedState = []; // hooks å­˜æ”¾åœ¨è¿™ä¸ªæ•°ç»„
let cursor = 0; // å½“å‰ memoizedState ä¸‹æ ‡

function useState(initialValue) {
  memoizedState[cursor] = memoizedState[cursor] || initialValue;
  const currentCursor = cursor;
  function setState(newState) {
    memoizedState[currentCursor] = newState;
    render();
  }
  return [memoizedState[cursor++], setState]; // è¿”å›å½“å‰ stateï¼Œå¹¶æŠŠ cursor åŠ  1
}

# 1. ä¸ä¼ depArray, æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œcallback
# 2. []  å°±æ‰§è¡Œä¸€æ¬¡
# 3. 
function useEffect(callback, depArray=[]) {
  const hasNoDeps = !depArray; # false
  const deps = memoizedState[cursor];
  # deps & depArray=[] æ¯”è¾ƒï¼Œ ä¸€ç›´æ˜¯ç©ºçš„ï¼Œ false
  # depArray çš„å­é¡¹éƒ½ä¸ºtrue => true => !true => false
  const hasChangedDeps = deps
    ? !depArray.every((el, i) => el === deps[i])
    : true;
  if (hasNoDeps || hasChangedDeps) {
    callback();
    memoizedState[cursor] = depArray;
  }
  cursor++;
}
```



æˆ‘ä»¬å†æ¥çœ‹çœ‹useReducer

```JavaScript
let memoizedState;	
function useReducer(reducer, initialArg, init) {	
  let initState = void 0;	
  if (typeof init !== 'undefined') {	
    initState = init(initialArg)	
  } else {	
    initState = initialArg	
  }	
  function dispatch(action) {	
    memoizedState = reducer(memoizedState, action)	
    render()	
  }	
  memoizedState = memoizedState || initState	
  return [memoizedState, dispatch]	
}	
	
function useState(initState) {	
  return useReducer((oldState, newState) => newState, initState)	
}

```


reactçš„å®ç°çš„qubie

å¿—ä½³è€å¸ˆ@2019